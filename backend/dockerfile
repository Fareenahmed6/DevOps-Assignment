# Multi-stage build for Flask backend application
# Stage 1: Install dependencies
FROM python:3.11-slim as deps

WORKDIR /app

# Install build dependencies and PyInstaller
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    curl \
    && pip install --no-cache-dir pyinstaller \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt


# Stage 2: Build executable
FROM deps as builder

WORKDIR /app

# Copy application code
COPY app/ ./app/

# Create spec file for PyInstaller
RUN echo 'a = ["app/main.py", "app/"]' > main.spec && \
    echo 'from PyInstaller.__main__ import _collect_python_scripts' >> main.spec

# Build standalone executable using PyInstaller
RUN pyinstaller --name app \
    --onefile \
    --windowed \
    --noconfirm \
    --clean \
    app/main.py

# Copy the executable
RUN cp dist/app /app/app


# Stage 3: Production - Minimal image without Python
FROM alpine:3.19 as production

# Install minimal runtime dependencies
RUN apk add --no-cache \
    libpq \
    ca-certificates \
    curl

# Create non-root user for security
RUN addgroup -g 1000 -S appgroup && adduser -u 1000 -S appuser -G appgroup

WORKDIR /app

# Copy executable from builder
COPY --from=builder /app/app /app/

# Set ownership
RUN chown -R appuser:appgroup /app

# Expose port
EXPOSE 8000

# Change to non-root user
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget -qO- http://localhost:8000/health || exit 1

# Run the executable
CMD ["/app/app"]
